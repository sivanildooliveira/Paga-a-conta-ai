<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Paga a Conta A√≠ üçª</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }

body {
    overflow: hidden;
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #07070f;
    color: white;
    height: 100vh;
    width: 100vw;
}

/* ===== PART√çCULAS FUNDO ===== */
#fundoParticulas {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 0; pointer-events: none;
}
.particula {
    position: absolute; border-radius: 50%;
    background: rgba(255,255,255,0.035);
    animation: flutuar linear infinite;
}
@keyframes flutuar {
    0%   { transform: translateY(100vh) scale(0); opacity: 0; }
    10%  { opacity: 1; }  90% { opacity: 1; }
    100% { transform: translateY(-10vh) scale(1); opacity: 0; }
}

/* ===== TELAS ===== */
.tela {
    display: none; width: 100vw; height: 100vh;
    position: absolute; top: 0; left: 0;
    justify-content: center; align-items: center;
    flex-direction: column; text-align: center;
    z-index: 10; padding: 20px;
}
.tela.visivel { display: flex; }

/* ===== TELA INICIAL ===== */
#telaInicial { background: radial-gradient(ellipse at 50% 40%, #151535 0%, #07070f 70%); }

.logo-container { margin-bottom: 10px; }

.logo-emoji {
    font-size: clamp(50px, 14vw, 100px);
    animation: logoFloat 3s ease-in-out infinite;
    display: inline-block;
}
@keyframes logoFloat {
    0%,100% { transform: translateY(0) rotate(-3deg); }
    50%     { transform: translateY(-12px) rotate(3deg); }
}

#telaInicial h1 {
    font-size: clamp(26px, 7.5vw, 56px);
    margin-bottom: 6px;
    background: linear-gradient(135deg, #f5af19, #f12711, #ff00cc, #6633ff);
    background-size: 300% 300%;
    -webkit-background-clip: text; background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gradiente 4s ease infinite;
}
@keyframes gradiente {
    0%  { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100%{ background-position: 0% 50%; }
}

.subtitulo {
    font-size: clamp(13px, 3vw, 19px);
    color: rgba(255,255,255,0.45);
    margin-bottom: 30px; letter-spacing: 2px;
}

.instrucoes {
    max-width: 380px; margin-bottom: 28px; padding: 18px 22px;
    background: rgba(255,255,255,0.04);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.08);
}
.instrucoes p {
    font-size: 14px; color: rgba(255,255,255,0.65);
    line-height: 2.1; text-align: left;
}

/* Config toggle */
.config-row {
    display: flex; justify-content: center; gap: 20px;
    margin-bottom: 24px;
}
.config-btn {
    padding: 8px 18px; font-size: 14px;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 30px; cursor: pointer;
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.6);
    transition: all 0.3s;
}
.config-btn.ativo {
    border-color: #f5af19;
    color: #f5af19;
    background: rgba(245,175,25,0.1);
}

/* ===== BOT√ïES ===== */
.botao-principal {
    padding: 18px 50px;
    font-size: clamp(16px, 4vw, 22px);
    font-weight: bold; border: none;
    border-radius: 50px; cursor: pointer;
    background: linear-gradient(135deg, #f5af19, #f12711);
    color: white; letter-spacing: 1px;
    text-transform: uppercase;
    position: relative; overflow: hidden;
    box-shadow: 0 4px 30px rgba(241,39,17,0.35);
    transition: transform 0.2s;
}
.botao-principal:active { transform: scale(0.95); }

.botao-principal::after {
    content: ''; position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.13) 50%, transparent 60%);
    animation: brilho 3s infinite;
}
@keyframes brilho {
    0%   { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

.botao-secundario {
    padding: 12px 36px; font-size: 15px;
    font-weight: bold;
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 50px; cursor: pointer;
    background: transparent; color: white;
    transition: all 0.3s; margin-top: 8px;
}

/* ===== √ÅREA DE TOQUE ===== */
#areaDeToque {
    position: relative; width: 100%; height: 100%;
    touch-action: none;
    background: radial-gradient(circle at center, #0e0e2a, #07070f);
    overflow: hidden;
}

/* Linhas neon decorativas */
#areaDeToque::before, #areaDeToque::after {
    content: ''; position: absolute; pointer-events: none;
    border-radius: 50%; opacity: 0.04;
}
#areaDeToque::before {
    width: 600px; height: 600px;
    top: 50%; left: 50%;
    transform: translate(-50%,-50%);
    border: 1px solid #6633ff;
}
#areaDeToque::after {
    width: 400px; height: 400px;
    top: 50%; left: 50%;
    transform: translate(-50%,-50%);
    border: 1px solid #ff00cc;
}

.mensagem-toque {
    position: absolute; top: 28px; width: 100%;
    font-size: clamp(15px, 3.8vw, 22px);
    color: rgba(255,255,255,0.55);
    z-index: 20; pointer-events: none;
    transition: all 0.4s;
}

.contador-jogadores {
    position: absolute; bottom: 28px; width: 100%;
    font-size: clamp(40px, 10vw, 80px);
    font-weight: bold;
    color: rgba(255,255,255,0.06);
    z-index: 20; pointer-events: none;
}

/* ===== BARRA DE PROGRESSO ===== */
.barra-container {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 4px;
    background: rgba(255,255,255,0.08);
    z-index: 30; pointer-events: none;
    opacity: 0; transition: opacity 0.3s;
}
.barra-container.ativa { opacity: 1; }

.barra-fill {
    height: 100%; width: 0%;
    background: linear-gradient(90deg, #00ff88, #ffcc00, #ff3366);
    border-radius: 0 3px 3px 0;
    transition: width 0.08s linear;
}

/* ===== BOLINHAS ===== */
.bolinha {
    position: absolute;
    width: 105px; height: 105px;
    border-radius: 50%;
    transform: translate(-50%,-50%);
    display: flex; align-items: center; justify-content: center;
    font-size: 26px; font-weight: bold;
    text-shadow: 0 2px 8px rgba(0,0,0,0.5);
    pointer-events: none;
    border: 2px solid rgba(255,255,255,0.25);
}

/* Aura / glow externo */
.bolinha::before {
    content: ''; position: absolute;
    width: 100%; height: 100%;
    border-radius: 50%;
    border: 2px solid currentColor;
    animation: onda 2s ease-out infinite;
    opacity: 0.35;
}
@keyframes onda {
    0%   { transform: scale(1);   opacity: 0.35; }
    100% { transform: scale(2.8); opacity: 0; }
}

/* Segundo anel mais lento */
.bolinha::after {
    content: ''; position: absolute;
    width: 100%; height: 100%;
    border-radius: 50%;
    border: 1px solid currentColor;
    animation: onda 2s 0.6s ease-out infinite;
    opacity: 0.2;
}

.bolinha-entrar {
    animation: entrar 0.35s cubic-bezier(0.34,1.56,0.64,1) forwards;
}
@keyframes entrar {
    0%   { transform: translate(-50%,-50%) scale(0); opacity: 0; }
    100% { transform: translate(-50%,-50%) scale(1); opacity: 1; }
}

.bolinha-pulsar {
    animation: pulsar 1.3s ease-in-out infinite;
}
@keyframes pulsar {
    0%   { transform: translate(-50%,-50%) scale(1);    box-shadow: 0 0 25px currentColor; }
    50%  { transform: translate(-50%,-50%) scale(1.10); box-shadow: 0 0 55px currentColor; }
    100% { transform: translate(-50%,-50%) scale(1);    box-shadow: 0 0 25px currentColor; }
}

/* Suspense ‚Äî micro vibra√ß√£o + pulsa√ß√£o forte */
.bolinha-suspense {
    animation: suspense 0.25s ease-in-out infinite alternate !important;
}
.bolinha-suspense::before, .bolinha-suspense::after { animation: none; opacity: 0; }

@keyframes suspense {
    0%   { transform: translate(-50%,-50%) scale(1)    translateX(-2px); opacity: 1;   box-shadow: 0 0 30px currentColor; }
    100% { transform: translate(-50%,-50%) scale(1.08) translateX(2px);  opacity: 0.45; box-shadow: 0 0 80px currentColor; }
}

.bolinha-vencedora {
    animation: vencedorZoom 1.6s ease forwards !important;
    z-index: 100;
}
.bolinha-vencedora::before, .bolinha-vencedora::after { animation: none; opacity: 0; }

@keyframes vencedorZoom {
    0%   { transform: translate(-50%,-50%) scale(1);   opacity: 1; }
    40%  { transform: translate(-50%,-50%) scale(3.5); opacity: 1; }
    100% { transform: translate(-50%,-50%) scale(5.5); opacity: 0; }
}

.bolinha-eliminada {
    animation: eliminar 0.5s ease forwards !important;
}
.bolinha-eliminada::before, .bolinha-eliminada::after { animation: none; opacity: 0; }

@keyframes eliminar {
    0%   { transform: translate(-50%,-50%) scale(1); opacity: 1; }
    100% { transform: translate(-50%,-50%) scale(0); opacity: 0; }
}

/* ===== RESULTADO ===== */
#telaResultado { background: radial-gradient(circle at center, #1a1a3e, #07070f); }

.resultado-container { display: flex; flex-direction: column; align-items: center; gap: 12px; }

.emoji-resultado {
    font-size: clamp(50px, 14vw, 110px);
    animation: quicar 0.6s ease infinite alternate;
}
@keyframes quicar {
    0%   { transform: translateY(0) scale(1); }
    100% { transform: translateY(-18px) scale(1.1); }
}

.texto-resultado {
    font-size: clamp(22px, 7vw, 52px);
    font-weight: bold;
    background: linear-gradient(135deg, #ffd700, #ff8c00, #ff3366);
    background-size: 200% 200%;
    -webkit-background-clip: text; background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gradiente 3s ease infinite;
}

.bolinha-resultado {
    width: 90px; height: 90px;
    border-radius: 50%;
    box-shadow: 0 0 40px var(--cor), 0 0 80px var(--cor);
    border: 3px solid rgba(255,255,255,0.25);
    display: flex; align-items: center; justify-content: center;
    font-size: 28px; font-weight: bold;
    animation: pulsarRes 1.5s ease infinite;
}
@keyframes pulsarRes {
    0%   { transform: scale(1);    box-shadow: 0 0 40px var(--cor); }
    50%  { transform: scale(1.13); box-shadow: 0 0 80px var(--cor); }
    100% { transform: scale(1);    box-shadow: 0 0 40px var(--cor); }
}

.frase { font-size: clamp(13px, 2.8vw, 16px); color: rgba(255,255,255,0.4); font-style: italic; max-width: 320px; }

/* Anima√ß√£o dinheiro voando */
.dinheiro-voando {
    position: fixed; z-index: 1000;
    pointer-events: none;
    font-size: 32px;
    animation: dinheiroCair linear forwards;
}
@keyframes dinheiroCair {
    0%   { transform: translateY(0) rotate(0deg) scale(1);   opacity: 1; }
    80%  { opacity: 1; }
    100% { transform: translateY(110vh) rotate(900deg) scale(0.5); opacity: 0; }
}

/* Carteira voando */
.carteira-voando {
    position: fixed; z-index: 999;
    pointer-events: none;
    font-size: 50px;
    animation: carteiraFly 2.5s ease-in-out forwards;
}
@keyframes carteiraFly {
    0%   { transform: translate(0, 0) rotate(0deg) scale(1);   opacity: 1; }
    30%  { transform: translate(30vw, -20vh) rotate(-30deg) scale(1.3); opacity: 1; }
    60%  { transform: translate(-20vw, -40vh) rotate(20deg) scale(0.9); opacity: 0.8; }
    100% { transform: translate(50vw, -60vh) rotate(-45deg) scale(0.4); opacity: 0; }
}

/* ===== CONFETES ===== */
.confete {
    position: fixed; top: -30px;
    z-index: 1001; pointer-events: none;
    animation: cair linear forwards;
}
@keyframes cair {
    0%   { transform: translateY(0) rotate(0deg) translateX(0);      opacity: 1; }
    50%  { transform: translateY(50vh) rotate(540deg) translateX(30px); opacity: 1; }
    100% { transform: translateY(110vh) rotate(1080deg) translateX(-20px); opacity: 0; }
}

/* ===== ERRO ===== */
#telaErro { background: radial-gradient(circle at center, #2a0a0a, #07070f); }

.erro-container { display: flex; flex-direction: column; align-items: center; gap: 14px; }

.emoji-erro {
    font-size: clamp(50px, 14vw, 100px);
    animation: balancar 0.4s ease infinite alternate;
}
@keyframes balancar { 0% { transform: rotate(-12deg); } 100% { transform: rotate(12deg); } }

.texto-erro { font-size: clamp(20px, 6vw, 38px); font-weight: bold; color: #ff4444; }
.subtexto-erro { font-size: clamp(13px, 2.8vw, 16px); color: rgba(255,255,255,0.4); max-width: 320px; }

/* ===== FLASHES ===== */
.flash-branco {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 50; pointer-events: none;
    animation: fB 0.5s ease forwards;
}
@keyframes fB { 0% { background: rgba(255,255,255,0.85); } 100% { background: transparent; } }

.flash-vermelho {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 50; pointer-events: none;
    animation: fV 0.6s ease forwards;
}
@keyframes fV { 0% { background: rgba(255,0,0,0.45); } 100% { background: transparent; } }

/* ===== N√öMERO CENTRAL (contagem) ===== */
.numero-central {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%,-50%);
    font-size: clamp(80px, 25vw, 200px);
    font-weight: bold;
    color: rgba(255,255,255,0.10);
    z-index: 25; pointer-events: none;
    animation: numAparece 0.7s ease forwards;
}
@keyframes numAparece {
    0%   { transform: translate(-50%,-50%) scale(3); opacity: 0; }
    100% { transform: translate(-50%,-50%) scale(1); opacity: 0.10; }
}

/* ===== OCULTAR √ÅUDIO ELEMENTS ===== */
audio { display: none; }
</style>
</head>
<body>

<div id="fundoParticulas"></div>

<!-- =========== TELA 1 ‚Äî IN√çCIO =========== -->
<div id="telaInicial" class="tela visivel">
    <div class="logo-container"><span class="logo-emoji">üçª</span></div>
    <h1>PAGA A CONTA A√ç</h1>
    <p class="subtitulo">Quem vai pagar a pr√≥xima rodada?</p>

    <div class="instrucoes">
        <p>üëÜ Cada jogador coloca o dedo na tela</p>
        <p>‚è≥ Aguardem o suspense crescer...</p>
        <p>üéØ N√£o tire o dedo! Quem sair perde</p>
        <p>üí∏ O sorteado paga a conta!</p>
    </div>

    <!-- Configura√ß√µes r√°pidas -->
    <div class="config-row">
        <button class="config-btn ativo" id="btnSom" onclick="jogo.alternarSom()">üîä Som</button>
        <button class="config-btn" id="btnIdioma" onclick="jogo.alternarIdioma()">üáßüá∑ PT</button>
    </div>

    <button class="botao-principal" onclick="jogo.iniciarRodada()">üé≤ INICIAR RODADA</button>
</div>

<!-- =========== TELA 2 ‚Äî MULTI-TOUCH =========== -->
<div id="telaToques" class="tela">
    <div id="areaDeToque">
        <div class="barra-container" id="barraContainer">
            <div class="barra-fill" id="barraFill"></div>
        </div>
        <h2 class="mensagem-toque" id="mensagemToque">üëÜ Coloquem os dedos na tela</h2>
        <div class="contador-jogadores" id="contadorJogadores">0</div>
    </div>
</div>

<!-- =========== TELA 3 ‚Äî RESULTADO =========== -->
<div id="telaResultado" class="tela">
    <div class="resultado-container">
        <div class="emoji-resultado" id="emojiResultado">üçª</div>
        <div class="texto-resultado" id="textoResultado">PAGA A CONTA A√ç!</div>
        <div class="bolinha-resultado" id="bolinhaResultado"></div>
        <p class="frase" id="fraseMotivacional"></p>
        <button class="botao-principal" onclick="jogo.reiniciar()">üîÑ NOVA RODADA</button>
        <button class="botao-secundario" onclick="jogo.voltarInicio()">üè† IN√çCIO</button>
    </div>
</div>

<!-- =========== TELA ERRO =========== -->
<div id="telaErro" class="tela">
    <div class="erro-container">
        <div class="emoji-erro">üêî</div>
        <div class="texto-erro" id="textoErro">ALGU√âM ARREGOU!</div>
        <p class="subtexto-erro" id="subtextoErro">Todos precisam manter o dedo na tela at√© o sorteio. Sem medo!</p>
        <button class="botao-principal" onclick="jogo.reiniciar()">üîÑ TENTAR DE NOVO</button>
        <button class="botao-secundario" onclick="jogo.voltarInicio()">üè† IN√çCIO</button>
    </div>
</div>

<script>
// ================================================================
//  CONFIGURA√á√ïES CENTRALIZADAS
// ================================================================
const CONFIG = {
    MINIMO_JOGADORES:       2,
    TEMPO_MINIMO_SUSPENSE:  5000,   // 5s m√≠nimo
    TEMPO_EXTRA_ALEATORIO:  3000,   // at√© +3s (total 5‚Äì8s)
    TEMPO_TENSAO_FINAL:     2000,   // fase "quem ser√°?"
    TEMPO_TRANSICAO:        2000,   // antes de exibir resultado
    TEMPO_DINHEIRO_VOANDO:  3000,   // dura√ß√£o da chuva
    TOTAL_CONFETES:         80,
    TOTAL_DINHEIRO:         25,
    TOTAL_PARTICULAS:       25,

    CORES: [
        '#ff3366','#33ccff','#ffcc00','#66ff66',
        '#ff66ff','#ff8833','#33ffcc','#cc66ff',
        '#ff5555','#55aaff','#ff1493','#00ff7f',
    ],

    FRASES_PT: [
        "A carteira chora, mas a amizade agradece! üòÇ",
        "Hoje √© voc√™, amanh√£... tamb√©m pode ser! ü§∑",
        "Beber √© opcional, pagar n√£o! üç∫",
        "O destino escolheu‚Ä¶ aceite com dignidade! üëë",
        "Pelo menos a cerveja vai ser boa! üçª",
        "Chora no caixa, ri na mesa! üòú",
        "Generosidade involunt√°ria √© a melhor! üí∞",
        "O universo conspira contra seu bolso! üåå",
        "Pix, cr√©dito ou sofrimento? üí≥",
        "Voc√™ n√£o perdeu, s√≥ investiu em amizade! ü•≤",
    ],
    FRASES_EN: [
        "Your wallet cries, but friendship thanks you! üòÇ",
        "Today it's you, tomorrow... also you! ü§∑",
        "Drinking is optional, paying is not! üç∫",
        "Destiny has chosen... accept it! üëë",
        "At least the beer is cold! üçª",
        "Cry at the register, laugh at the table! üòú",
        "Involuntary generosity is the best kind! üí∞",
        "The universe conspires against your wallet! üåå",
    ],

    EMOJIS_CONFETE: ['üéâ','üéä','üí∏','üç∫','üçª','‚ú®','üí∞','ü™ô','‚≠ê','ü•≥'],
    EMOJIS_DINHEIRO: ['üí∏','üíµ','üí¥','üí∂','üí∑','ü™ô','üí∞'],

    TEXTOS: {
        pt: {
            colocarDedo:  'üëÜ Coloquem os dedos na tela',
            faltam:       (n) => `üëÜ Faltam ${n} dedo(s)`,
            preparemSe:   '‚è≥ Preparem-se...',
            naoTirem:     'üî• N√£o tirem o dedo!',
            quemSera:     'üò± QUEM SER√Å?!',
            resultado:    'PAGA A CONTA A√ç!',
            arregou:      'ALGU√âM ARREGOU!',
            arregouSub:   'Todos precisam manter o dedo na tela at√© o sorteio. Sem medo!',
        },
        en: {
            colocarDedo:  'üëÜ Place your fingers on the screen',
            faltam:       (n) => `üëÜ Need ${n} more finger(s)`,
            preparemSe:   '‚è≥ Get ready...',
            naoTirem:     "üî• Don't lift your finger!",
            quemSera:     'üò± WHO WILL IT BE?!',
            resultado:    'YOU PAY THE BILL!',
            arregou:      'SOMEONE CHICKENED OUT!',
            arregouSub:   'Everyone must keep their finger on the screen until the draw. No fear!',
        },
    },
};

// ================================================================
//  REFER√äNCIAS DO DOM
// ================================================================
const DOM = {
    telaInicial:        document.getElementById('telaInicial'),
    telaToques:         document.getElementById('telaToques'),
    telaResultado:      document.getElementById('telaResultado'),
    telaErro:           document.getElementById('telaErro'),
    areaDeToque:        document.getElementById('areaDeToque'),
    mensagemToque:      document.getElementById('mensagemToque'),
    contadorJogadores:  document.getElementById('contadorJogadores'),
    barraContainer:     document.getElementById('barraContainer'),
    barraFill:          document.getElementById('barraFill'),
    bolinhaResultado:   document.getElementById('bolinhaResultado'),
    fraseMotivacional:  document.getElementById('fraseMotivacional'),
    emojiResultado:     document.getElementById('emojiResultado'),
    textoResultado:     document.getElementById('textoResultado'),
    textoErro:          document.getElementById('textoErro'),
    subtextoErro:       document.getElementById('subtextoErro'),
    fundoParticulas:    document.getElementById('fundoParticulas'),
    btnSom:             document.getElementById('btnSom'),
    btnIdioma:          document.getElementById('btnIdioma'),
};

// ================================================================
//  UTILIT√ÅRIOS
// ================================================================
function aleatorio(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function escolher(lista) {
    return lista[Math.floor(Math.random() * lista.length)];
}

function mostrarTela(el) {
    document.querySelectorAll('.tela').forEach(t => t.classList.remove('visivel'));
    el.classList.add('visivel');
}

function criarFlash(classe) {
    const d = document.createElement('div');
    d.className = classe;
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 800);
}

// ================================================================
//  SISTEMA DE SOM (Web Audio API ‚Äî sem arquivos externos)
// ================================================================
const som = {
    ctx: null,
    ativo: true,

    /** Inicializa o AudioContext (precisa de gesto do usu√°rio) */
    inicializar() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (this.ctx.state === 'suspended') this.ctx.resume();
    },

    /** Som curto de "pop" ao colocar dedo */
    pop() {
        if (!this.ativo || !this.ctx) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(900, this.ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(400, this.ctx.currentTime + 0.1);
        g.gain.setValueAtTime(0.25, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.15);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + 0.15);
    },

    /** Efeito de tens√£o crescente */
    tensao(duracao) {
        if (!this.ativo || !this.ctx) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(80, this.ctx.currentTime);
        o.frequency.linearRampToValueAtTime(400, this.ctx.currentTime + duracao / 1000);
        g.gain.setValueAtTime(0.0, this.ctx.currentTime);
        g.gain.linearRampToValueAtTime(0.15, this.ctx.currentTime + duracao / 1000);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duracao / 1000 + 0.1);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + duracao / 1000 + 0.2);
    },

    /** "Tcharam!" ‚Äî fanfarra de resultado */
    fanfarra() {
        if (!this.ativo || !this.ctx) return;
        const notas = [523, 659, 784, 1047]; // C5 E5 G5 C6
        notas.forEach((freq, i) => {
            const o = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            o.type = 'square';
            o.frequency.value = freq;
            g.gain.setValueAtTime(0.18, this.ctx.currentTime + i * 0.15);
            g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + i * 0.15 + 0.5);
            o.connect(g); g.connect(this.ctx.destination);
            o.start(this.ctx.currentTime + i * 0.15);
            o.stop(this.ctx.currentTime + i * 0.15 + 0.5);
        });
    },

    /** Risada zoeira (buzzy descending) */
    risada() {
        if (!this.ativo || !this.ctx) return;
        for (let i = 0; i < 6; i++) {
            const o = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            o.type = 'triangle';
            const t = this.ctx.currentTime + 0.6 + i * 0.12;
            o.frequency.setValueAtTime(600 - i * 60, t);
            o.frequency.exponentialRampToValueAtTime(200, t + 0.1);
            g.gain.setValueAtTime(0.12, t);
            g.gain.exponentialRampToValueAtTime(0.001, t + 0.12);
            o.connect(g); g.connect(this.ctx.destination);
            o.start(t); o.stop(t + 0.12);
        }
    },

    /** Som de erro */
    erro() {
        if (!this.ativo || !this.ctx) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = 'square';
        o.frequency.setValueAtTime(300, this.ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.4);
        g.gain.setValueAtTime(0.2, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.5);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + 0.5);
    },

    /** Tick de contagem */
    tick() {
        if (!this.ativo || !this.ctx) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 1200;
        g.gain.setValueAtTime(0.1, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.06);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + 0.06);
    },
};

// ================================================================
//  EFEITOS VISUAIS
// ================================================================
const efeitos = {
    criarParticulasFundo() {
        DOM.fundoParticulas.innerHTML = '';
        for (let i = 0; i < CONFIG.TOTAL_PARTICULAS; i++) {
            const p = document.createElement('div');
            p.className = 'particula';
            const t = aleatorio(4, 18);
            p.style.width = t + 'px';
            p.style.height = t + 'px';
            p.style.left = Math.random() * 100 + '%';
            p.style.animationDuration = aleatorio(10, 22) + 's';
            p.style.animationDelay = Math.random() * 12 + 's';
            DOM.fundoParticulas.appendChild(p);
        }
    },

    lancarConfetes() {
        for (let i = 0; i < CONFIG.TOTAL_CONFETES; i++) {
            setTimeout(() => {
                const c = document.createElement('div');
                c.className = 'confete';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.animationDuration = (2.5 + Math.random() * 2) + 's';

                if (Math.random() > 0.5) {
                    c.textContent = escolher(CONFIG.EMOJIS_CONFETE);
                    c.style.fontSize = aleatorio(16, 28) + 'px';
                } else {
                    const s = aleatorio(6, 12);
                    c.style.width = s + 'px';
                    c.style.height = s + 'px';
                    c.style.background = escolher(CONFIG.CORES);
                    c.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                }
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 5000);
            }, i * 25);
        }
    },

    lancarDinheiroVoando() {
        for (let i = 0; i < CONFIG.TOTAL_DINHEIRO; i++) {
            setTimeout(() => {
                const d = document.createElement('div');
                d.className = 'dinheiro-voando';
                d.textContent = escolher(CONFIG.EMOJIS_DINHEIRO);
                d.style.left = Math.random() * 100 + 'vw';
                d.style.top = '-40px';
                d.style.fontSize = aleatorio(24, 42) + 'px';
                d.style.animationDuration = (2 + Math.random() * 1.5) + 's';
                document.body.appendChild(d);
                setTimeout(() => d.remove(), 4000);
            }, i * 80);
        }
    },

    lancarCarteirasVoando() {
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                const c = document.createElement('div');
                c.className = 'carteira-voando';
                c.textContent = 'üëõ';
                c.style.left = (20 + Math.random() * 60) + 'vw';
                c.style.bottom = '10vh';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3000);
            }, i * 600);
        }
    },

    mostrarNumeroCentral(texto) {
        const anterior = DOM.areaDeToque.querySelector('.numero-central');
        if (anterior) anterior.remove();
        const d = document.createElement('div');
        d.className = 'numero-central';
        d.textContent = texto;
        DOM.areaDeToque.appendChild(d);
        setTimeout(() => d.remove(), 1200);
    },
};

// ================================================================
//  BARRA DE PROGRESSO
// ================================================================
const barra = {
    intervalo: null,
    inicio: 0,
    duracao: 0,

    iniciar(ms) {
        this.inicio = Date.now();
        this.duracao = ms;
        DOM.barraContainer.classList.add('ativa');
        DOM.barraFill.style.width = '0%';

        this.intervalo = setInterval(() => {
            const pct = Math.min(((Date.now() - this.inicio) / this.duracao) * 100, 100);
            DOM.barraFill.style.width = pct + '%';
            if (pct >= 100) this.parar();
        }, 50);
    },

    parar()  { clearInterval(this.intervalo); this.intervalo = null; },

    resetar() {
        this.parar();
        DOM.barraContainer.classList.remove('ativa');
        DOM.barraFill.style.width = '0%';
    },
};

// ================================================================
//  JOGO PRINCIPAL
// ================================================================
const jogo = {
    // ----- Estado -----
    jogadores: {},            // { touchId: { bolinha, cor, numero } }
    contagemIniciada: false,
    rodadaFinalizada: false,
    timerSorteio: null,
    timerTensao: null,
    proximoNumero: 0,
    somAtivo: true,
    idioma: 'pt',              // 'pt' ou 'en'

    /** Textos do idioma atual */
    t() { return CONFIG.TEXTOS[this.idioma]; },

    /** Frases do idioma atual */
    frases() { return this.idioma === 'pt' ? CONFIG.FRASES_PT : CONFIG.FRASES_EN; },

    // ----- ALTERNAR SOM -----
    alternarSom() {
        this.somAtivo = !this.somAtivo;
        som.ativo = this.somAtivo;
        DOM.btnSom.textContent = this.somAtivo ? 'üîä Som' : 'üîá Mudo';
        DOM.btnSom.classList.toggle('ativo', this.somAtivo);
    },

    // ----- ALTERNAR IDIOMA -----
    alternarIdioma() {
        this.idioma = this.idioma === 'pt' ? 'en' : 'pt';
        DOM.btnIdioma.textContent = this.idioma === 'pt' ? 'üáßüá∑ PT' : 'üá∫üá∏ EN';
    },

    // ----- INICIAR RODADA -----
    iniciarRodada() {
        som.inicializar();
        this.limparEstado();
        mostrarTela(DOM.telaToques);
        DOM.mensagemToque.textContent = this.t().colocarDedo;
        DOM.contadorJogadores.textContent = '0';
    },

    // ----- REINICIAR -----
    reiniciar() {
        som.inicializar();
        this.limparEstado();
        mostrarTela(DOM.telaToques);
        DOM.mensagemToque.textContent = this.t().colocarDedo;
        DOM.contadorJogadores.textContent = '0';
    },

    // ----- VOLTAR IN√çCIO -----
    voltarInicio() {
        this.limparEstado();
        mostrarTela(DOM.telaInicial);
    },

    // ----- LIMPAR ESTADO -----
    limparEstado() {
        clearTimeout(this.timerSorteio);
        clearTimeout(this.timerTensao);
        barra.resetar();

        Object.values(this.jogadores).forEach(j => j.bolinha.remove());
        this.jogadores = {};

        DOM.areaDeToque.querySelectorAll('.numero-central').forEach(n => n.remove());

        // Limpar efeitos residuais
        document.querySelectorAll('.confete, .dinheiro-voando, .carteira-voando').forEach(e => e.remove());

        this.contagemIniciada = false;
        this.rodadaFinalizada = false;
        this.proximoNumero = 0;
    },

    // ----- TOTAL JOGADORES -----
    totalJogadores() {
        return Object.keys(this.jogadores).length;
    },

    // ----- ATUALIZAR UI -----
    atualizarUI() {
        const total = this.totalJogadores();
        DOM.contadorJogadores.textContent = total;

        if (total < CONFIG.MINIMO_JOGADORES) {
            DOM.mensagemToque.textContent = this.t().faltam(CONFIG.MINIMO_JOGADORES - total);
        } else if (!this.contagemIniciada) {
            DOM.mensagemToque.textContent = this.t().preparemSe;
        } else {
            DOM.mensagemToque.textContent = this.t().naoTirem;
        }
    },

    // ----- ADICIONAR JOGADOR -----
    adicionarJogador(toque) {
        if (this.rodadaFinalizada) return;

        this.proximoNumero++;
        const numero = this.proximoNumero;
        const cor = CONFIG.CORES[(numero - 1) % CONFIG.CORES.length];

        // Criar bolinha
        const bolinha = document.createElement('div');
        bolinha.className = 'bolinha bolinha-entrar';
        bolinha.style.background = cor;
        bolinha.style.color = cor;
        bolinha.style.boxShadow = `0 0 30px ${cor}, inset 0 0 20px rgba(255,255,255,0.15)`;
        bolinha.style.left = toque.clientX + 'px';
        bolinha.style.top = toque.clientY + 'px';
        bolinha.textContent = numero;

        // Ap√≥s entrada ‚Üí pulsar
        bolinha.addEventListener('animationend', function handler() {
            bolinha.classList.remove('bolinha-entrar');
            bolinha.classList.add('bolinha-pulsar');
            bolinha.removeEventListener('animationend', handler);
        });

        DOM.areaDeToque.appendChild(bolinha);

        this.jogadores[toque.identifier] = { bolinha, cor, numero };

        // Som de pop
        som.pop();

        this.atualizarUI();

        // Iniciar contagem se atingiu m√≠nimo
        if (this.totalJogadores() >= CONFIG.MINIMO_JOGADORES && !this.contagemIniciada) {
            this.iniciarContagem();
        }
    },

    // ----- MOVER JOGADOR -----
    moverJogador(toque) {
        const j = this.jogadores[toque.identifier];
        if (j) {
            j.bolinha.style.left = toque.clientX + 'px';
            j.bolinha.style.top = toque.clientY + 'px';
        }
    },

    // ----- REMOVER JOGADOR -----
    removerJogador(toque) {
        const j = this.jogadores[toque.identifier];
        if (!j) return;
        j.bolinha.remove();
        delete this.jogadores[toque.identifier];
        this.atualizarUI();

        if (!this.rodadaFinalizada && this.contagemIniciada && this.totalJogadores() < CONFIG.MINIMO_JOGADORES) {
            this.cancelarRodada();
        }
    },

    // ----- INICIAR CONTAGEM -----
    iniciarContagem() {
        this.contagemIniciada = true;
        this.atualizarUI();

        const tempoSuspense = CONFIG.TEMPO_MINIMO_SUSPENSE + Math.random() * CONFIG.TEMPO_EXTRA_ALEATORIO;
        barra.iniciar(tempoSuspense);

        // Som de tens√£o crescente
        som.tensao(tempoSuspense);

        // Mostrar contagem visual (n√∫meros grandes)
        const segundos = Math.ceil(tempoSuspense / 1000);
        for (let i = segundos; i >= 1; i--) {
            const atraso = (segundos - i) * 1000;
            setTimeout(() => {
                if (!this.rodadaFinalizada && this.contagemIniciada) {
                    efeitos.mostrarNumeroCentral(i);
                    som.tick();
                }
            }, atraso);
        }

        this.timerSorteio = setTimeout(() => this.faseTensaoFinal(), tempoSuspense);
    },

    // ----- FASE DE TENS√ÉO FINAL (micro vibra√ß√µes, piscar) -----
    faseTensaoFinal() {
        if (this.rodadaFinalizada) return;

        DOM.mensagemToque.textContent = this.t().quemSera;
        efeitos.mostrarNumeroCentral('?');

        // Todas as bolinhas entram em modo suspense
        Object.values(this.jogadores).forEach(j => {
            j.bolinha.classList.remove('bolinha-pulsar');
            j.bolinha.classList.add('bolinha-suspense');
        });

        // Vibrar dispositivo
        if (navigator.vibrate) navigator.vibrate([80, 40, 80, 40, 80, 40, 150]);

        this.timerTensao = setTimeout(() => this.sortearPagador(), CONFIG.TEMPO_TENSAO_FINAL);
    },

    // ----- SORTEAR PAGADOR -----
    sortearPagador() {
        if (this.rodadaFinalizada) return;

        this.rodadaFinalizada = true;
        this.contagemIniciada = false;
        barra.parar();

        const ids = Object.keys(this.jogadores);
        if (ids.length < CONFIG.MINIMO_JOGADORES) {
            this.cancelarRodada();
            return;
        }

        // Escolher aleat√≥rio
        const idSorteado = escolher(ids);
        const pagador = this.jogadores[idSorteado];

        // Flash branco dram√°tico
        criarFlash('flash-branco');

        // Fanfarra + risada
        som.fanfarra();
        som.risada();

        // Vibrar forte
        if (navigator.vibrate) navigator.vibrate(600);

        // Eliminar os outros
        ids.forEach(id => {
            if (id !== idSorteado) {
                const j = this.jogadores[id];
                j.bolinha.classList.remove('bolinha-suspense');
                j.bolinha.classList.add('bolinha-eliminada');
            }
        });

        // Zoom no vencedor
        pagador.bolinha.classList.remove('bolinha-suspense');
        pagador.bolinha.classList.add('bolinha-vencedora');

        // Transi√ß√£o para resultado
        setTimeout(() => this.mostrarResultado(pagador), CONFIG.TEMPO_TRANSICAO);
    },

    // ----- MOSTRAR RESULTADO -----
    mostrarResultado(pagador) {
        // Configurar bolinha de resultado
        DOM.bolinhaResultado.style.background = pagador.cor;
        DOM.bolinhaResultado.style.setProperty('--cor', pagador.cor);
        DOM.bolinhaResultado.textContent = pagador.numero;

        // Texto de resultado
        DOM.textoResultado.textContent = this.t().resultado;

        // Frase motivacional
        DOM.fraseMotivacional.textContent = escolher(this.frases());

        mostrarTela(DOM.telaResultado);

        // Efeitos visuais cont√≠nuos de 2-3s
        efeitos.lancarConfetes();
        efeitos.lancarDinheiroVoando();
        efeitos.lancarCarteirasVoando();

        // Segunda onda de confetes
        setTimeout(() => efeitos.lancarConfetes(), 1500);

        // Limpar bolinhas
        Object.values(this.jogadores).forEach(j => j.bolinha.remove());
        this.jogadores = {};
    },

    // ----- CANCELAR RODADA -----
    cancelarRodada() {
        clearTimeout(this.timerSorteio);
        clearTimeout(this.timerTensao);
        barra.resetar();

        this.contagemIniciada = false;
        this.rodadaFinalizada = true;

        criarFlash('flash-vermelho');
        som.erro();

        if (navigator.vibrate) navigator.vibrate([200, 80, 200]);

        // Textos de erro
        DOM.textoErro.textContent = this.t().arregou;
        DOM.subtextoErro.textContent = this.t().arregouSub;

        // Eliminar bolinhas restantes
        Object.values(this.jogadores).forEach(j => {
            j.bolinha.classList.remove('bolinha-pulsar', 'bolinha-suspense');
            j.bolinha.classList.add('bolinha-eliminada');
        });

        setTimeout(() => {
            Object.values(this.jogadores).forEach(j => j.bolinha.remove());
            this.jogadores = {};
            mostrarTela(DOM.telaErro);
        }, 600);
    },
};

// ================================================================
//  EVENTOS DE TOQUE
// ================================================================
DOM.areaDeToque.addEventListener('touchstart', (e) => {
    e.preventDefault();
    for (const t of e.changedTouches) jogo.adicionarJogador(t);
}, { passive: false });

DOM.areaDeToque.addEventListener('touchmove', (e) => {
    e.preventDefault();
    for (const t of e.changedTouches) jogo.moverJogador(t);
}, { passive: false });

DOM.areaDeToque.addEventListener('touchend', (e) => {
    e.preventDefault();
    for (const t of e.changedTouches) jogo.removerJogador(t);
}, { passive: false });

DOM.areaDeToque.addEventListener('touchcancel', (e) => {
    for (const t of e.changedTouches) jogo.removerJogador(t);
});

// ================================================================
//  INICIALIZA√á√ÉO
// ================================================================
efeitos.criarParticulasFundo();
</script>
</body>
</html>
